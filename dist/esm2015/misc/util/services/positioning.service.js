import Popper from "popper.js";
export const PositioningPlacement = {
    Auto: "auto",
    TopLeft: "top left",
    Top: "top",
    TopRight: "top right",
    LeftTop: "left top",
    Left: "left",
    LeftBottom: "left bottom",
    BottomLeft: "bottom left",
    Bottom: "bottom",
    BottomRight: "bottom right",
    RightTop: "right top",
    Right: "right",
    RightBottom: "right bottom"
};
function placementToPopper(placement) {
    if (!placement || placement === PositioningPlacement.Auto) {
        return "auto";
    }
    // All placements of the format: `direction alignment`, e.g. `top left`.
    const [direction, alignment] = placement.split(" ");
    // Direction alone covers case of just `top`, `left`, `bottom`, `right`.
    const chosenPlacement = [direction];
    // Add `start` / `end` to placement, depending on alignment direction.
    switch (alignment) {
        case "top":
        case "left":
            chosenPlacement.push("start");
            break;
        case "bottom":
        case "right":
            chosenPlacement.push("end");
            break;
    }
    // Join with hyphen to create Popper compatible placement.
    return chosenPlacement.join("-");
}
function popperToPlacement(popper) {
    if (!popper || popper === "auto") {
        return "auto";
    }
    const [direction, alignment] = popper.split("-");
    const chosenPlacement = [direction];
    switch (direction) {
        case "top":
        case "bottom":
            switch (alignment) {
                case "start":
                    chosenPlacement.push("left");
                    break;
                case "end":
                    chosenPlacement.push("right");
                    break;
            }
            break;
        case "left":
        case "right":
            switch (alignment) {
                case "start":
                    chosenPlacement.push("top");
                    break;
                case "end":
                    chosenPlacement.push("bottom");
                    break;
            }
            break;
    }
    return chosenPlacement.join(" ");
}
export class PositioningService {
    constructor(anchor, subject, placement, arrowSelector) {
        this.anchor = anchor;
        this.subject = subject;
        this._placement = placement;
        this._arrowSelector = arrowSelector;
        this.init();
    }
    get placement() {
        return this._placement;
    }
    set placement(placement) {
        this._placement = placement;
        if (this._popper) {
            this._popper.options.placement = placementToPopper(placement);
        }
    }
    set hasArrow(hasArrow) {
        this._hasArrow = hasArrow;
    }
    get actualPlacement() {
        if (!this._popperState) {
            return PositioningPlacement.Auto;
        }
        return popperToPlacement(this._popperState.placement);
    }
    get state() {
        return this._popperState;
    }
    init() {
        const modifiers = {
            computeStyle: {
                gpuAcceleration: false
            },
            preventOverflow: {
                escapeWithReference: true,
                boundariesElement: document.body
            },
            arrow: {
                element: this._arrowSelector
            },
            offset: {
                fn: (data) => {
                    if (this._hasArrow) {
                        const offsets = this.calculateOffsets();
                        data.offsets.popper.left += offsets.left;
                        data.offsets.popper.top += offsets.top;
                    }
                    return data;
                }
            }
        };
        if (!this._arrowSelector) {
            delete modifiers.arrow;
        }
        this._popper = new Popper(this.anchor.nativeElement, this.subject.nativeElement, {
            placement: placementToPopper(this._placement),
            modifiers,
            onCreate: initial => this._popperState = initial,
            onUpdate: update => this._popperState = update
        });
    }
    update() {
        this._popper.update();
    }
    destroy() {
        this._popper.destroy();
    }
    calculateOffsets() {
        let left = 0;
        let top = 0;
        // To support correct positioning for all popup sizes we should calculate offset using em
        const fontSize = parseFloat(window.getComputedStyle(this.subject.nativeElement).getPropertyValue("font-size"));
        // The Semantic UI popup arrow width and height are 0.71428571em and the margin from the popup edge is 1em
        const arrowCenter = (0.71428571 / 2 + 1) * fontSize;
        if (this.anchor.nativeElement.offsetWidth <= arrowCenter * 2) {
            const anchorCenterWidth = this.anchor.nativeElement.offsetWidth / 2;
            if (this._placement === PositioningPlacement.TopLeft || this._placement === PositioningPlacement.BottomLeft) {
                left = anchorCenterWidth - arrowCenter;
            }
            if (this._placement === PositioningPlacement.TopRight || this._placement === PositioningPlacement.BottomRight) {
                left = arrowCenter - anchorCenterWidth;
            }
        }
        if (this.anchor.nativeElement.offsetHeight <= arrowCenter * 2) {
            const anchorCenterHeight = this.anchor.nativeElement.offsetHeight / 2;
            if (this._placement === PositioningPlacement.LeftTop || this._placement === PositioningPlacement.RightTop) {
                top = anchorCenterHeight - arrowCenter;
            }
            if (this._placement === PositioningPlacement.LeftBottom || this._placement === PositioningPlacement.RightBottom) {
                top = arrowCenter - anchorCenterHeight;
            }
        }
        return { top, left, width: 0, height: 0 };
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicG9zaXRpb25pbmcuc2VydmljZS5qcyIsInNvdXJjZVJvb3QiOiJuZzovL25nMi1zZW1hbnRpYy11aS8iLCJzb3VyY2VzIjpbIm1pc2MvdXRpbC9zZXJ2aWNlcy9wb3NpdGlvbmluZy5zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUNBLE9BQU8sTUFBcUQsTUFBTSxXQUFXLENBQUM7QUFtQjlFLE1BQU0sQ0FBQyxNQUFNLG9CQUFvQixHQUFHO0lBQ2hDLElBQUksRUFBRSxNQUE4QjtJQUNwQyxPQUFPLEVBQUUsVUFBa0M7SUFDM0MsR0FBRyxFQUFFLEtBQTZCO0lBQ2xDLFFBQVEsRUFBRSxXQUFtQztJQUM3QyxPQUFPLEVBQUUsVUFBa0M7SUFDM0MsSUFBSSxFQUFFLE1BQThCO0lBQ3BDLFVBQVUsRUFBRSxhQUFxQztJQUNqRCxVQUFVLEVBQUUsYUFBcUM7SUFDakQsTUFBTSxFQUFFLFFBQWdDO0lBQ3hDLFdBQVcsRUFBRSxjQUFzQztJQUNuRCxRQUFRLEVBQUUsV0FBbUM7SUFDN0MsS0FBSyxFQUFFLE9BQStCO0lBQ3RDLFdBQVcsRUFBRSxjQUFzQztDQUN0RCxDQUFDO0FBV0YsU0FBUyxpQkFBaUIsQ0FBQyxTQUE4QjtJQUNyRCxJQUFJLENBQUMsU0FBUyxJQUFJLFNBQVMsS0FBSyxvQkFBb0IsQ0FBQyxJQUFJLEVBQUU7UUFDdkQsT0FBTyxNQUFNLENBQUM7S0FDakI7SUFFRCx3RUFBd0U7SUFDeEUsTUFBTSxDQUFDLFNBQVMsRUFBRSxTQUFTLENBQUMsR0FBRyxTQUFTLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRXBELHdFQUF3RTtJQUN4RSxNQUFNLGVBQWUsR0FBRyxDQUFDLFNBQVMsQ0FBQyxDQUFDO0lBRXBDLHNFQUFzRTtJQUN0RSxRQUFRLFNBQVMsRUFBRTtRQUNmLEtBQUssS0FBSyxDQUFDO1FBQ1gsS0FBSyxNQUFNO1lBQ1AsZUFBZSxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQztZQUM5QixNQUFNO1FB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SSxJQUFJLENBQUMsVUFBVSxLQUFLLG9CQUFvQixDQUFDLFFBQVEsRUFBRTtnQkFDdkcsR0FBRyxHQUFHLGtCQUFrQixHQUFHLFdBQVcsQ0FBQzthQUMxQztZQUNELElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxvQkFBb0IsQ0FBQyxVQUFVLElBQUksSUFBSSxDQUFDLFVBQVUsS0FBSyxvQkFBb0IsQ0FBQyxXQUFXLEVBQUU7Z0JBQzdHLEdBQUcsR0FBRyxXQUFXLEdBQUcsa0JBQWtCLENBQUM7YUFDMUM7U0FDSjtRQUNELE9BQU8sRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxDQUFDO0lBQzlDLENBQUM7Q0FFSiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7IEVsZW1lbnRSZWYgfSBmcm9tIFwiQGFuZ3VsYXIvY29yZVwiO1xuaW1wb3J0IFBvcHBlciwgeyBNb2RpZmllcnMsIFBvcHBlck9wdGlvbnMsIFBsYWNlbWVudCwgRGF0YSB9IGZyb20gXCJwb3BwZXIuanNcIjtcblxudHlwZSBQb3BwZXJNb2RpZmllcnMgPSBNb2RpZmllcnMgJiB7XG4gICAgY29tcHV0ZVN0eWxlPzp7XG4gICAgICAgIGdwdUFjY2VsZXJhdGlvbjpib29sZWFuO1xuICAgIH07XG59O1xudHlwZSBQb3BwZXJJbnN0YW5jZSA9IFBvcHBlciAmIHtcbiAgICBvcHRpb25zOlBvcHBlck9wdGlvbnMgJiB7XG4gICAgICAgIG1vZGlmaWVyczpQb3BwZXJNb2RpZmllcnM7XG4gICAgfTtcbn07XG5cbmV4cG9ydCB0eXBlIFBvc2l0aW9uaW5nUGxhY2VtZW50ID0gXCJhdXRvXCIgfFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInRvcCBsZWZ0XCIgfCBcInRvcFwiIHwgXCJ0b3AgcmlnaHRcIiB8XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIFwiYm90dG9tIGxlZnRcIiB8IFwiYm90dG9tXCIgfCBcImJvdHRvbSByaWdodFwiIHxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgXCJsZWZ0IHRvcFwiIHwgXCJsZWZ0XCIgfCBcImxlZnQgYm90dG9tXCIgfFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBcInJpZ2h0IHRvcFwiIHwgXCJyaWdodFwiIHwgXCJyaWdodCBib3R0b21cIjtcblxuZXhwb3J0IGNvbnN0IFBvc2l0aW9uaW5nUGxhY2VtZW50ID0ge1xuICAgIEF1dG86IFwiYXV0b1wiIGFzIFBvc2l0aW9uaW5nUGxhY2VtZW50LFxuICAgIFRvcExlZnQ6IFwidG9wIGxlZnRcIiBhcyBQb3NpdGlvbmluZ1BsYWNlbWVudCxcbiAgICBUb3A6IFwidG9wXCIgYXMgUG9zaXRpb25pbmdQbGFjZW1lbnQsXG4gICAgVG9wUmlnaHQ6IFwidG9wIHJpZ2h0XCIgYXMgUG9zaXRpb25pbmdQbGFjZW1lbnQsXG4gICAgTGVmdFRvcDogXCJsZWZ0IHRvcFwiIGFzIFBvc2l0aW9uaW5nUGxhY2VtZW50LFxuICAgIExlZnQ6IFwibGVmdFwiIGFzIFBvc2l0aW9uaW5nUGxhY2VtZW50LFxuICAgIExlZnRCb3R0b206IFwibGVmdCBib3R0b21cIiBhcyBQb3NpdGlvbmluZ1BsYWNlbWVudCxcbiAgICBCb3R0b21MZWZ0OiBcImJvdHRvbSBsZWZ0XCIgYXMgUG9zaXRpb25pbmdQbGFjZW1lbnQsXG4gICAgQm90dG9tOiBcImJvdHRvbVwiIGFzIFBvc2l0aW9uaW5nUGxhY2VtZW50LFxuICAgIEJvdHRvbVJpZ2h0OiBcImJvdHRvbSByaWdodFwiIGFzIFBvc2l0aW9uaW5nUGxhY2VtZW50LFxuICAgIFJpZ2h0VG9wOiBcInJpZ2h0IHRvcFwiIGFzIFBvc2l0aW9uaW5nUGxhY2VtZW50LFxuICAgIFJpZ2h0OiBcInJpZ2h0XCIgYXMgUG9zaXRpb25pbmdQbGFjZW1lbnQsXG4gICAgUmlnaHRCb3R0b206IFwicmlnaHQgYm90dG9tXCIgYXMgUG9zaXRpb25pbmdQbGFjZW1lbnRcbn07XG5cbmV4cG9ydCBpbnRlcmZhY2UgSVBvc2l0aW9uQm91bmRpbmdCb3gge1xuICAgIHdpZHRoOm51bWJlcjtcbiAgICBoZWlnaHQ6bnVtYmVyO1xuICAgIHRvcDpudW1iZXI7XG4gICAgbGVmdDpudW1iZXI7XG4gICAgYm90dG9tOm51bWJlcjtcbiAgICByaWdodDpudW1iZXI7XG59XG5cbmZ1bmN0aW9uIHBsYWNlbWVudFRvUG9wcGVyKHBsYWNlbWVudDpQb3NpdGlvbmluZ1BsYWNlbWVudCk6UGxhY2VtZW50IHtcbiAgICBpZiAoIXBsYWNlbWVudCB8fCBwbGFjZW1lbnQgPT09IFBvc2l0aW9uaW5nUGxhY2VtZW50LkF1dG8pIHtcbiAgICAgICAgcmV0dXJuIFwiYXV0b1wiO1xuICAgIH1cblxuICAgIC8vIEFsbCBwbGFjZW1lbnRzIG9mIHRoZSBmb3JtYXQ6IGBkaXJlY3Rpb24gYWxpZ25tZW50YCwgZS5nLiBgdG9wIGxlZnRgLlxuICAgIGNvbnN0IFtkaXJlY3Rpb24sIGFsaWdubWVudF0gPSBwbGFjZW1lbnQuc3BsaXQoXCIgXCIpO1xuXG4gICAgLy8gRGlyZWN0aW9uIGFsb25lIGNvdmVycyBjYXNlIG9mIGp1c3QgYHRvcGAsIGBsZWZ0YCwgYGJvdHRvbWAsIGByaWdodGAuXG4gICAgY29uc3QgY2hvc2VuUGxhY2VtZW50ID0gW2RpcmVjdGlvbl07XG5cbiAgICAvLyBBZGQgYHN0YXJ0YCAvIGBlbmRgIHRvIHBsYWNlbWVudCwgZGVwZW5kaW5nIG9uIGFsaWdubWVudCBkaXJlY3Rpb24uXG4gICAgc3dpdGNoIChhbGlnbm1lbnQpIHtcbiAgICAgICAgY2FzZSBcInRvcFwiOlxuICAgICAgICBjYXNlIFwibGVmdFwiOlxuICAgICAgICAgICAgY2hvc2VuUGxhY2VtZW50LnB1c2goXCJzdGFydFwiKTtcbiAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlIFwiYm90dG9tXCI6XG4gICAgICAgIGNhc2UgXCJyaWdodFwiOlxuICAgICAgICAgICAgY2hvc2VuUGxhY2VtZW50LnB1c2goXCJlbmRcIik7XG4gICAgICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICAvLyBKb2luIHdpdGggaHlwaGVuIHRvIGNyZWF0ZSBQb3BwZXIgY29tcGF0aWJsZSBwbGFjZW1lbnQuXG4gICAgcmV0dXJuIGNob3NlblBsYWNlbWVudC5qb2luKFwiLVwiKSBhcyBQbGFjZW1lbnQ7XG59XG5cbmZ1bmN0aW9uIHBvcHBlclRvUGxhY2VtZW50KHBvcHBlcjpzdHJpbmcpOlBvc2l0aW9uaW5nUGxhY2VtZW50IHtcbiAgICBpZiAoIXBvcHBlciB8fCBwb3BwZXIgPT09IFwiYXV0b1wiKSB7XG4gICAgICAgIHJldHVybiBcImF1dG9cIjtcbiAgICB9XG5cbiAgICBjb25zdCBbZGlyZWN0aW9uLCBhbGlnbm1lbnRdID0gcG9wcGVyLnNwbGl0KFwiLVwiKTtcblxuICAgIGNvbnN0IGNob3NlblBsYWNlbWVudCA9IFtkaXJlY3Rpb25dO1xuXG4gICAgc3dpdGNoIChkaXJlY3Rpb24pIHtcbiAgICAgICAgY2FzZSBcInRvcFwiOlxuICAgICAgICBjYXNlIFwiYm90dG9tXCI6XG4gICAgICAgICAgICBzd2l0Y2ggKGFsaWdubWVudCkge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJzdGFydFwiOlxuICAgICAgICAgICAgICAgICAgICBjaG9zZW5QbGFjZW1lbnQucHVzaChcImxlZnRcIik7XG4gICAgICAgICAgICAgICAgICAgIGJyZWFrO1xuICAgICAgICAgICAgICAgIGNhc2UgXCJlbmRcIjpcbiAgICAgICAgICAgICAgICAgICAgY2hvc2VuUGxhY2VtZW50LnB1c2goXCJyaWdodFwiKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSBcImxlZnRcIjpcbiAgICAgICAgY2FzZSBcInJpZ2h0XCI6XG4gICAgICAgICAgICBzd2l0Y2ggKGFsaWdubWVudCkge1xuICAgICAgICAgICAgICAgIGNhc2UgXCJzdGFydFwiOlxuICAgICAgICAgICAgICAgICAgICBjaG9zZW5QbGFjZW1lbnQucHVzaChcInRvcFwiKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICAgICAgY2FzZSBcImVuZFwiOlxuICAgICAgICAgICAgICAgICAgICBjaG9zZW5QbGFjZW1lbnQucHVzaChcImJvdHRvbVwiKTtcbiAgICAgICAgICAgICAgICAgICAgYnJlYWs7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBicmVhaztcbiAgICB9XG5cbiAgICByZXR1cm4gY2hvc2VuUGxhY2VtZW50LmpvaW4oXCIgXCIpIGFzIFBvc2l0aW9uaW5nUGxhY2VtZW50O1xufVxuXG5leHBvcnQgY2xhc3MgUG9zaXRpb25pbmdTZXJ2aWNlIHtcbiAgICBwdWJsaWMgcmVhZG9ubHkgYW5jaG9yOkVsZW1lbnRSZWY7XG4gICAgcHVibGljIHJlYWRvbmx5IHN1YmplY3Q6RWxlbWVudFJlZjtcblxuICAgIHByaXZhdGUgX3BvcHBlcjpQb3BwZXJJbnN0YW5jZTtcbiAgICBwcml2YXRlIF9wb3BwZXJTdGF0ZTpEYXRhO1xuICAgIHByaXZhdGUgX3BsYWNlbWVudDpQb3NpdGlvbmluZ1BsYWNlbWVudDtcbiAgICBwcml2YXRlIF9oYXNBcnJvdzpib29sZWFuO1xuICAgIHByaXZhdGUgX2Fycm93U2VsZWN0b3I6c3RyaW5nIHwgdW5kZWZpbmVkO1xuXG4gICAgcHVibGljIGdldCBwbGFjZW1lbnQoKTpQb3NpdGlvbmluZ1BsYWNlbWVudCB7XG4gICAgICAgIHJldHVybiB0aGlzLl9wbGFjZW1lbnQ7XG4gICAgfVxuXG4gICAgcHVibGljIHNldCBwbGFjZW1lbnQocGxhY2VtZW50OlBvc2l0aW9uaW5nUGxhY2VtZW50KSB7XG4gICAgICAgIHRoaXMuX3BsYWNlbWVudCA9IHBsYWNlbWVudDtcbiAgICAgICAgaWYgKHRoaXMuX3BvcHBlcikge1xuICAgICAgICAgICAgdGhpcy5fcG9wcGVyLm9wdGlvbnMucGxhY2VtZW50ID0gcGxhY2VtZW50VG9Qb3BwZXIocGxhY2VtZW50KTtcbiAgICAgICAgfVxuICAgIH1cblxuICAgIHB1YmxpYyBzZXQgaGFzQXJyb3coaGFzQXJyb3c6Ym9vbGVhbikge1xuICAgICAgICB0aGlzLl9oYXNBcnJvdyA9IGhhc0Fycm93O1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgYWN0dWFsUGxhY2VtZW50KCk6UG9zaXRpb25pbmdQbGFjZW1lbnQge1xuICAgICAgICBpZiAoIXRoaXMuX3BvcHBlclN0YXRlKSB7XG4gICAgICAgICAgICByZXR1cm4gUG9zaXRpb25pbmdQbGFjZW1lbnQuQXV0bztcbiAgICAgICAgfVxuXG4gICAgICAgIHJldHVybiBwb3BwZXJUb1BsYWNlbWVudCh0aGlzLl9wb3BwZXJTdGF0ZS5wbGFjZW1lbnQpO1xuICAgIH1cblxuICAgIHB1YmxpYyBnZXQgc3RhdGUoKTpEYXRhIHtcbiAgICAgICAgcmV0dXJuIHRoaXMuX3BvcHBlclN0YXRlO1xuICAgIH1cblxuICAgIGNvbnN0cnVjdG9yKGFuY2hvcjpFbGVtZW50UmVmLCBzdWJqZWN0OkVsZW1lbnRSZWYsIHBsYWNlbWVudDpQb3NpdGlvbmluZ1BsYWNlbWVudCwgYXJyb3dTZWxlY3Rvcj86c3RyaW5nKSB7XG4gICAgICAgIHRoaXMuYW5jaG9yID0gYW5jaG9yO1xuICAgICAgICB0aGlzLnN1YmplY3QgPSBzdWJqZWN0O1xuICAgICAgICB0aGlzLl9wbGFjZW1lbnQgPSBwbGFjZW1lbnQ7XG4gICAgICAgIHRoaXMuX2Fycm93U2VsZWN0b3IgPSBhcnJvd1NlbGVjdG9yO1xuICAgICAgICB0aGlzLmluaXQoKTtcbiAgICB9XG5cbiAgICBwdWJsaWMgaW5pdCgpOnZvaWQge1xuICAgICAgICBjb25zdCBtb2RpZmllcnM6UG9wcGVyTW9kaWZpZXJzID0ge1xuICAgICAgICAgICAgY29tcHV0ZVN0eWxlOiB7XG4gICAgICAgICAgICAgICAgZ3B1QWNjZWxlcmF0aW9uOiBmYWxzZVxuICAgICAgICAgICAgfSxcbiAgICAgICAgICAgIHByZXZlbnRPdmVyZmxvdzoge1xuICAgICAgICAgICAgICAgIGVzY2FwZVdpdGhSZWZlcmVuY2U6IHRydWUsXG4gICAgICAgICAgICAgICAgYm91bmRhcmllc0VsZW1lbnQ6IGRvY3VtZW50LmJvZHlcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBhcnJvdzoge1xuICAgICAgICAgICAgICAgIGVsZW1lbnQ6IHRoaXMuX2Fycm93U2VsZWN0b3JcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICBvZmZzZXQ6IHtcbiAgICAgICAgICAgICAgICBmbjogKGRhdGE6UG9wcGVyLkRhdGEpID0+IHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKHRoaXMuX2hhc0Fycm93KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBvZmZzZXRzID0gdGhpcy5jYWxjdWxhdGVPZmZzZXRzKCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBkYXRhLm9mZnNldHMucG9wcGVyLmxlZnQgKz0gb2Zmc2V0cy5sZWZ0O1xuICAgICAgICAgICAgICAgICAgICAgICAgZGF0YS5vZmZzZXRzLnBvcHBlci50b3AgKz0gb2Zmc2V0cy50b3A7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgcmV0dXJuIGRhdGE7XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICB9O1xuXG4gICAgICAgIGlmICghdGhpcy5fYXJyb3dTZWxlY3Rvcikge1xuICAgICAgICAgICAgZGVsZXRlIG1vZGlmaWVycy5hcnJvdztcbiAgICAgICAgfVxuXG4gICAgICAgIHRoaXMuX3BvcHBlciA9IG5ldyBQb3BwZXIoXG4gICAgICAgICAgICB0aGlzLmFuY2hvci5uYXRpdmVFbGVtZW50LFxuICAgICAgICAgICAgdGhpcy5zdWJqZWN0Lm5hdGl2ZUVsZW1lbnQsXG4gICAgICAgICAgICB7XG4gICAgICAgICAgICAgICAgcGxhY2VtZW50OiBwbGFjZW1lbnRUb1BvcHBlcih0aGlzLl9wbGFjZW1lbnQpLFxuICAgICAgICAgICAgICAgIG1vZGlmaWVycyxcbiAgICAgICAgICAgICAgICBvbkNyZWF0ZTogaW5pdGlhbCA9PiB0aGlzLl9wb3BwZXJTdGF0ZSA9IGluaXRpYWwsXG4gICAgICAgICAgICAgICAgb25VcGRhdGU6IHVwZGF0ZSA9PiB0aGlzLl9wb3BwZXJTdGF0ZSA9IHVwZGF0ZVxuICAgICAgICAgICAgfSkgYXMgUG9wcGVySW5zdGFuY2U7XG4gICAgfVxuXG4gICAgcHVibGljIHVwZGF0ZSgpOnZvaWQge1xuICAgICAgICB0aGlzLl9wb3BwZXIudXBkYXRlKCk7XG4gICAgfVxuXG4gICAgcHVibGljIGRlc3Ryb3koKTp2b2lkIHtcbiAgICAgICAgdGhpcy5fcG9wcGVyLmRlc3Ryb3koKTtcbiAgICB9XG5cbiAgICBwcml2YXRlIGNhbGN1bGF0ZU9mZnNldHMoKTpQb3BwZXIuT2Zmc2V0IHtcbiAgICAgICAgbGV0IGxlZnQgPSAwOyBsZXQgdG9wID0gMDtcblxuICAgICAgICAvLyBUbyBzdXBwb3J0IGNvcnJlY3QgcG9zaXRpb25pbmcgZm9yIGFsbCBwb3B1cCBzaXplcyB3ZSBzaG91bGQgY2FsY3VsYXRlIG9mZnNldCB1c2luZyBlbVxuICAgICAgICBjb25zdCBmb250U2l6ZSA9IHBhcnNlRmxvYXQod2luZG93LmdldENvbXB1dGVkU3R5bGUodGhpcy5zdWJqZWN0Lm5hdGl2ZUVsZW1lbnQpLmdldFByb3BlcnR5VmFsdWUoXCJmb250LXNpemVcIikpO1xuICAgICAgICAvLyBUaGUgU2VtYW50aWMgVUkgcG9wdXAgYXJyb3cgd2lkdGggYW5kIGhlaWdodCBhcmUgMC43MTQyODU3MWVtIGFuZCB0aGUgbWFyZ2luIGZyb20gdGhlIHBvcHVwIGVkZ2UgaXMgMWVtXG4gICAgICAgIGNvbnN0IGFycm93Q2VudGVyID0gKDAuNzE0Mjg1NzEgLyAyICsgMSkgKiBmb250U2l6ZTtcblxuICAgICAgICBpZiAodGhpcy5hbmNob3IubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aCA8PSBhcnJvd0NlbnRlciAqIDIpIHtcbiAgICAgICAgICAgIGNvbnN0IGFuY2hvckNlbnRlcldpZHRoID0gdGhpcy5hbmNob3IubmF0aXZlRWxlbWVudC5vZmZzZXRXaWR0aCAvIDI7XG4gICAgICAgICAgICBpZiAodGhpcy5fcGxhY2VtZW50ID09PSBQb3NpdGlvbmluZ1BsYWNlbWVudC5Ub3BMZWZ0IHx8IHRoaXMuX3BsYWNlbWVudCA9PT0gUG9zaXRpb25pbmdQbGFjZW1lbnQuQm90dG9tTGVmdCkge1xuICAgICAgICAgICAgICAgIGxlZnQgPSBhbmNob3JDZW50ZXJXaWR0aCAtIGFycm93Q2VudGVyO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgaWYgKHRoaXMuX3BsYWNlbWVudCA9PT0gUG9zaXRpb25pbmdQbGFjZW1lbnQuVG9wUmlnaHQgfHwgdGhpcy5fcGxhY2VtZW50ID09PSBQb3NpdGlvbmluZ1BsYWNlbWVudC5Cb3R0b21SaWdodCkge1xuICAgICAgICAgICAgICAgIGxlZnQgPSBhcnJvd0NlbnRlciAtIGFuY2hvckNlbnRlcldpZHRoO1xuICAgICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKHRoaXMuYW5jaG9yLm5hdGl2ZUVsZW1lbnQub2Zmc2V0SGVpZ2h0IDw9IGFycm93Q2VudGVyICogMikge1xuICAgICAgICAgICAgY29uc3QgYW5jaG9yQ2VudGVySGVpZ2h0ID0gdGhpcy5hbmNob3IubmF0aXZlRWxlbWVudC5vZmZzZXRIZWlnaHQgLyAyO1xuICAgICAgICAgICAgaWYgKHRoaXMuX3BsYWNlbWVudCA9PT0gUG9zaXRpb25pbmdQbGFjZW1lbnQuTGVmdFRvcCB8fCB0aGlzLl9wbGFjZW1lbnQgPT09IFBvc2l0aW9uaW5nUGxhY2VtZW50LlJpZ2h0VG9wKSB7XG4gICAgICAgICAgICAgICAgdG9wID0gYW5jaG9yQ2VudGVySGVpZ2h0IC0gYXJyb3dDZW50ZXI7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBpZiAodGhpcy5fcGxhY2VtZW50ID09PSBQb3NpdGlvbmluZ1BsYWNlbWVudC5MZWZ0Qm90dG9tIHx8IHRoaXMuX3BsYWNlbWVudCA9PT0gUG9zaXRpb25pbmdQbGFjZW1lbnQuUmlnaHRCb3R0b20pIHtcbiAgICAgICAgICAgICAgICB0b3AgPSBhcnJvd0NlbnRlciAtIGFuY2hvckNlbnRlckhlaWdodDtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICByZXR1cm4geyB0b3AsIGxlZnQsIHdpZHRoOiAwLCBoZWlnaHQ6IDAgfTtcbiAgICB9XG5cbn1cbiJdfQ==